#!/bin/sh
set -x # echo commands executed
set -e # fail script on any individual command failing

target=${1:-"release"}
echo "Target is $target"

if [ "$target" == "clean" ]
then
    rm -rf build/*
elif [ "$target" == "deploy" ]
then
    if [ ! -f samconfig.toml ]; 
    then 
        sam deploy --guided --template-file build/template.yaml
        mv build/samconfig.toml ./samconfig.toml
    else 
        sam deploy --template-file build/template.yaml --config-file ../samconfig.toml;
    fi
elif [ "$target" == "release" ]
then
    rm -rf build/*

    lib_farm="$(brazil-path build.libfarm)/lib"

    cp sam-app/lambda_functions/template.yaml build/
    cp LICENSE build/
    cp README.md build/

    cp -r sam-app/lambda_functions/ build/sam-app-deployment-artifact
    mkdir build/sam-app-deployment-artifact/lib
    (cd build/ && zip -r -j sam-app-deployment-artifact.zip sam-app-deployment-artifact/)
    rm -rf build/sam-app-deployment-artifact/
    
    mkdir -p build/python/lib/
    cp -r $lib_farm/python3.10 build/python/lib
    (cd build/ && zip -r lambda_layers python)
    rm -rf build/python/
else
    printf "$target is not a valid argument"
    exit 1
fi